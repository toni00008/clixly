<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clixly â€¢ Profile</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: auto;
      background: #f9f9f9;
      padding: 20px;
      text-align: center;
    }
    h2 {
      margin-bottom: 0;
    }
    .counts {
      margin: 10px 0 20px;
      font-size: 1.1em;
      color: #555;
    }
    button.follow-btn {
      padding: 10px 20px;
      background: #0077ff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <h2 id="username">Loading...</h2>
  <div class="counts">
    <span id="followersCount">Followers: 0</span> |
    <span id="followingCount">Following: 0</span>
  </div>
  <button id="followBtn" class="follow-btn" style="display:none;"></button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, updateDoc, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
      authDomain: "clixly-bc284.firebaseapp.com",
      projectId: "clixly-bc284",
      storageBucket: "clixly-bc284.appspot.com",
      messagingSenderId: "33343695899",
      appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const urlParams = new URLSearchParams(window.location.search);
    const profileUserId = urlParams.get('id');

    const usernameEl = document.getElementById('username');
    const followersCountEl = document.getElementById('followersCount');
    const followingCountEl = document.getElementById('followingCount');
    const followBtn = document.getElementById('followBtn');

    let currentUser = null;
    let profileUserData = null;
    let currentUserData = null;

    onAuthStateChanged(auth, async user => {
      if (!user) {
        usernameEl.innerText = 'Please login to view profiles.';
        return;
      }
      currentUser = user;

      if (!profileUserId) {
        usernameEl.innerText = 'No user ID provided in URL.';
        return;
      }

      await loadProfileUser();
      await loadCurrentUser();
      renderProfile();
    });

    async function loadProfileUser() {
      const docSnap = await getDoc(doc(db, 'users', profileUserId));
      if (!docSnap.exists()) {
        usernameEl.innerText = 'User not found.';
        followBtn.style.display = 'none';
        return;
      }
      profileUserData = docSnap.data();
    }

    async function loadCurrentUser() {
      const docSnap = await getDoc(doc(db, 'users', currentUser.uid));
      currentUserData = docSnap.exists() ? docSnap.data() : { following: [] };
    }

    function renderProfile() {
      usernameEl.innerText = profileUserData.username || 'Unknown User';

      const followers = profileUserData.followers || [];
      const following = profileUserData.following || [];

      followersCountEl.innerText = `Followers: ${followers.length}`;
      followingCountEl.innerText = `Following: ${following.length}`;

      // Show follow/unfollow button only if not viewing own profile
      if (currentUser.uid !== profileUserId) {
        followBtn.style.display = 'inline-block';
        if ((currentUserData.following || []).includes(profileUserId)) {
          followBtn.innerText = 'Unfollow';
        } else {
          followBtn.innerText = 'Follow';
        }
      } else {
        followBtn.style.display = 'none'; // Hide button on own profile
      }
    }

    followBtn.onclick = async () => {
      const currentUserRef = doc(db, 'users', currentUser.uid);
      const profileUserRef = doc(db, 'users', profileUserId);

      const isFollowing = (currentUserData.following || []).includes(profileUserId);

      if (isFollowing) {
        // Unfollow
        await updateDoc(currentUserRef, {
          following: arrayRemove(profileUserId)
        });
        await updateDoc(profileUserRef, {
          followers: arrayRemove(currentUser.uid)
        });
      } else {
        // Follow
        await updateDoc(currentUserRef, {
          following: arrayUnion(profileUserId)
        });
        await updateDoc(profileUserRef, {
          followers: arrayUnion(currentUser.uid)
        });
      }

      // Refresh data
      await loadCurrentUser();
      await loadProfileUser();
      renderProfile();
    };
  </script>
</body>
</html>


