<!DOCTYPE html>
<html>
<head>
  <title>Clixly Profile</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: auto; background: #f9f9f9; padding: 20px; }
    #followBtn { background: #0077ff; color: white; padding: 8px 16px; border-radius: 5px; border: none; cursor: pointer; font-size: 1em; }
    #followBtn.unfollow { background: #ccc; color: black; }
  </style>
</head>
<body>

  <h2 id="username">Loading...</h2>
  <p>ðŸ‘¥ Followers: <span id="followersCount">0</span> â€¢ Following: <span id="followingCount">0</span></p>
  <button id="followBtn" style="display:none;">Follow</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, updateDoc, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
      authDomain: "clixly-bc284.firebaseapp.com",
      projectId: "clixly-bc284",
      storageBucket: "clixly-bc284.appspot.com",
      messagingSenderId: "33343695899",
      appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const urlParams = new URLSearchParams(window.location.search);
    const profileUserId = urlParams.get('id'); // Profile user id from URL param: ?id=USER_ID

    const usernameEl = document.getElementById('username');
    const followersCountEl = document.getElementById('followersCount');
    const followingCountEl = document.getElementById('followingCount');
    const followBtn = document.getElementById('followBtn');

    let currentUser = null;
    let isFollowing = false;

    onAuthStateChanged(auth, async user => {
      if (!user) {
        usernameEl.textContent = 'Please log in to view profiles';
        followBtn.style.display = 'none';
        return;
      }

      currentUser = user;

      if (!profileUserId) {
        usernameEl.textContent = 'No profile specified';
        return;
      }

      await loadProfile();
    });

    async function loadProfile() {
      const profileDocRef = doc(db, 'users', profileUserId);
      const profileSnap = await getDoc(profileDocRef);

      if (!profileSnap.exists()) {
        usernameEl.textContent = 'User not found';
        return;
      }

      const profileData = profileSnap.data();
      usernameEl.textContent = profileData.username || 'Unknown User';

      // Get followers and following arrays (store as arrays in user doc for simplicity)
      const followers = profileData.followers || [];
      const following = profileData.following || [];

      followersCountEl.textContent = followers.length;
      followingCountEl.textContent = following.length;

      // Check if current user is following this profile user
      isFollowing = followers.includes(currentUser.uid);

      updateFollowButton();
    }

    function updateFollowButton() {
      followBtn.style.display = (profileUserId === currentUser.uid) ? 'none' : 'inline-block';
      if (isFollowing) {
        followBtn.textContent = 'Unfollow';
        followBtn.classList.add('unfollow');
      } else {
        followBtn.textContent = 'Follow';
        followBtn.classList.remove('unfollow');
      }
    }

    followBtn.addEventListener('click', async () => {
      if (isFollowing) {
        // Unfollow: remove currentUser.uid from profileUserId followers
        // Remove profileUserId from currentUser following
        await updateDoc(doc(db, 'users', profileUserId), {
          followers: arrayRemove(currentUser.uid)
        });
        await updateDoc(doc(db, 'users', currentUser.uid), {
          following: arrayRemove(profileUserId)
        });
        isFollowing = false;
      } else {
        // Follow: add currentUser.uid to profileUserId followers
        // Add profileUserId to currentUser following
        await updateDoc(doc(db, 'users', profileUserId), {
          followers: arrayUnion(currentUser.uid)
        });
        await updateDoc(doc(db, 'users', currentUser.uid), {
          following: arrayUnion(profileUserId)
        });
        isFollowing = true;
      }
      await loadProfile(); // Refresh counts and button state
    });
  </script>
</body>
</html>



