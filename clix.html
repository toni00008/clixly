<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Clix Feed - Clixly</title>
  <style>
    /* Reset and basic */
    * {
      box-sizing: border-box;
      margin: 0; padding: 0;
    }
    body, html {
      height: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: black;
      color: white;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Container that holds all clix */
    #clix-container {
      height: 100vh;
      overflow: hidden;
      scroll-snap-type: y mandatory;
      scroll-behavior: smooth;
    }

    /* Each clix/video item */
    .clix-item {
      position: relative;
      height: 100vh;
      width: 100vw;
      scroll-snap-align: start;
      display: flex;
      justify-content: center;
      align-items: center;
      background: black;
    }

    video {
      max-height: 100vh;
      max-width: 100vw;
      object-fit: cover;
    }

    /* Overlay with info */
    .overlay {
      position: absolute;
      bottom: 60px;
      left: 20px;
      right: 80px;
      color: white;
      text-shadow: 0 0 10px rgba(0,0,0,0.8);
      font-size: 16px;
      line-height: 1.3;
      user-select: none;
    }

    .username {
      font-weight: 700;
      margin-bottom: 5px;
    }

    .caption {
      font-weight: 400;
      opacity: 0.9;
      white-space: pre-wrap;
    }

    /* Like button container */
    .like-container {
      position: absolute;
      right: 20px;
      bottom: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      user-select: none;
    }

    .like-btn {
      font-size: 28px;
      cursor: pointer;
      color: rgba(255,255,255,0.7);
      transition: color 0.3s ease;
      user-select: none;
    }
    .like-btn.liked {
      color: #ff2f6d;
      filter: drop-shadow(0 0 5px #ff2f6d);
      transform: scale(1.3);
    }

    .like-count {
      font-size: 14px;
      color: #fff;
      opacity: 0.8;
      user-select: none;
    }

    /* Scrollbar hidden */
    #clix-container::-webkit-scrollbar {
      display: none;
    }

    /* Loading indicator */
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 18px;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="loading">Loading Clix...</div>
  <div id="clix-container" style="display:none;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase config - replace with your own!
    const firebaseConfig = {
      apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
      authDomain: "clixly-bc284.firebaseapp.com",
      projectId: "clixly-bc284",
      storageBucket: "clixly-bc284.appspot.com",
      messagingSenderId: "33343695899",
      appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const clixContainer = document.getElementById('clix-container');
    const loading = document.getElementById('loading');

    // For demo, we fetch 20 latest clix videos
    async function fetchClix() {
      try {
        const clixQuery = query(
          collection(db, "posts"),
          where("type", "==", "clix"),
          orderBy("createdAt", "desc"),
          limit(20)
        );
        const querySnapshot = await getDocs(clixQuery);
        if (querySnapshot.empty) {
          loading.textContent = "No Clix found.";
          return;
        }

        const clixData = [];
        querySnapshot.forEach(doc => {
          clixData.push({ id: doc.id, ...doc.data() });
        });

        renderClix(clixData);
      } catch (e) {
        loading.textContent = "Error loading Clix: " + e.message;
      }
    }

    // Render all clix items
    function renderClix(clixList) {
      clixContainer.innerHTML = '';
      clixList.forEach((clix, index) => {
        const item = document.createElement('div');
        item.className = 'clix-item';

        const video = document.createElement('video');
        video.src = clix.mediaURL;
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');
        video.preload = 'metadata';
        video.loop = false;
        video.controls = false;
        video.muted = true;
        video.autoplay = false;

        item.appendChild(video);

        // Overlay for username and caption
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.innerHTML = `
          <div class="username">@${clix.username || 'unknown'}</div>
          <div class="caption">${escapeHtml(clix.caption || '')}</div>
        `;
        item.appendChild(overlay);

        // Like container
        const likeContainer = document.createElement('div');
        likeContainer.className = 'like-container';

        const likeBtn = document.createElement('div');
        likeBtn.className = 'like-btn';
        likeBtn.innerHTML = '❤';
        likeBtn.title = "Like";
        likeContainer.appendChild(likeBtn);

        const likeCount = document.createElement('div');
        likeCount.className = 'like-count';
        likeCount.textContent = clix.likesCount || 0;
        likeContainer.appendChild(likeCount);

        item.appendChild(likeContainer);

        // Like logic with localStorage
        const likedKey = 'liked-clix-' + clix.id;
        if(localStorage.getItem(likedKey) === 'true') {
          likeBtn.classList.add('liked');
        }

        likeBtn.addEventListener('click', () => {
          if(likeBtn.classList.contains('liked')) {
            likeBtn.classList.remove('liked');
            likeCount.textContent = Math.max(0, parseInt(likeCount.textContent) - 1);
            localStorage.setItem(likedKey, 'false');
          } else {
            likeBtn.classList.add('liked');
            likeCount.textContent = parseInt(likeCount.textContent) + 1;
            localStorage.setItem(likedKey, 'true');
          }
          // Optional: sync likes with backend Firestore here
        });

        clixContainer.appendChild(item);
      });

      loading.style.display = 'none';
      clixContainer.style.display = 'block';

      setupVideoScroll();
    }

    // Escape HTML for safety
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, function(m) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        })[m];
      });
    }

    // Autoplay video in viewport & pause others
    function setupVideoScroll() {
      const videos = document.querySelectorAll('video');

      function playVisibleVideo() {
        videos.forEach(video => {
          const rect = video.getBoundingClientRect();
          if(rect.top >= 0 && rect.bottom <= window.innerHeight) {
            if(video.paused) video.play();
          } else {
            if(!video.paused) video.pause();
          }
        });
      }

      playVisibleVideo();
      window.addEventListener('scroll', () => {
        playVisibleVideo();
      });

      // Also handle keyboard arrows for desktop scroll
      window.addEventListener('keydown', e => {
        if(e.key === 'ArrowDown') {
          window.scrollBy({top: window.innerHeight, behavior: 'smooth'});
        } else if(e.key === 'ArrowUp') {
          window.scrollBy({top: -window.innerHeight, behavior: 'smooth'});
        }
      });
    }

    // Kickoff fetch
    fetchClix();
  </script>
</body>
</html>

