<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clix â€¢ Short Videos</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f2f5f9;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    .clix-container {
      max-width: 600px;
      width: 100%;
      background: white;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    video {
      width: 100%;
      border-radius: 10px;
      background: black;
    }
    .info {
      margin-top: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .username {
      font-weight: 700;
      color: #0077ff;
    }
    .caption {
      margin-top: 6px;
      font-size: 0.9em;
      color: #333;
    }
    button {
      cursor: pointer;
      background: #0077ff;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      margin-left: 8px;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .comment-section {
      margin-top: 15px;
    }
    .comments-list {
      max-height: 150px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.9em;
      color: #555;
    }
    .comment-item {
      border-bottom: 1px solid #ddd;
      padding: 6px 0;
    }
    .comment-author {
      font-weight: 700;
      color: #0077ff;
    }
    .comment-text {
      margin-left: 5px;
      color: #333;
    }
    .comment-input {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    .comment-input input {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
  </style>
</head>
<body>

  <h1>ðŸ”¥ Clix - Short Videos</h1>
  <div id="clixList"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Firebase config - replace with your own
    const firebaseConfig = {
      apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
      authDomain: "clixly-bc284.firebaseapp.com",
      projectId: "clixly-bc284",
      storageBucket: "clixly-bc284.appspot.com",
      messagingSenderId: "33343695899",
      appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;

    onAuthStateChanged(auth, user => {
      currentUser = user;
    });

    const clixList = document.getElementById('clixList');

    // Load Clix videos (type='clix') ordered by newest first
    const postsRef = collection(db, 'posts');
    const clixQuery = query(postsRef, where('type', '==', 'clix'), orderBy('createdAt', 'desc'), limit(20));

    onSnapshot(clixQuery, snapshot => {
      clixList.innerHTML = ''; // Clear

      snapshot.forEach(doc => {
        const data = doc.data();
        const id = doc.id;

        const container = document.createElement('div');
        container.classList.add('clix-container');

        // Video element with loop, playsinline, controls, muted default
        const video = document.createElement('video');
        video.src = data.mediaURL;
        video.loop = true;
        video.playsInline = true;
        video.controls = false;
        video.muted = true; // Start muted, user can unmute
        video.style.cursor = 'pointer';

        // Toggle mute/unmute on click
        video.addEventListener('click', () => {
          video.muted = !video.muted;
          muteBtn.textContent = video.muted ? 'ðŸ”‡ Unmute' : 'ðŸ”Š Mute';
        });

        // Info: username and caption
        const infoDiv = document.createElement('div');
        infoDiv.classList.add('info');

        const usernameSpan = document.createElement('span');
        usernameSpan.classList.add('username');
        usernameSpan.textContent = '@' + (data.username || 'unknown');

        // Share button
        const shareBtn = document.createElement('button');
        shareBtn.textContent = 'Share';
        shareBtn.addEventListener('click', async () => {
          const shareData = {
            title: 'Clix by ' + (data.username || 'unknown'),
            text: data.caption || '',
            url: window.location.origin + '/clix.html?video=' + encodeURIComponent(data.mediaURL),
          };
          try {
            if (navigator.share) {
              await navigator.share(shareData);
            } else {
              // fallback: copy URL to clipboard
              await navigator.clipboard.writeText(shareData.url);
              alert('Link copied to clipboard!');
            }
          } catch (err) {
            alert('Error sharing: ' + err.message);
          }
        });

        // Mute/unmute toggle button
        const muteBtn = document.createElement('button');
        muteBtn.textContent = 'ðŸ”‡ Unmute';
        muteBtn.addEventListener('click', () => {
          video.muted = !video.muted;
          muteBtn.textContent = video.muted ? 'ðŸ”‡ Unmute' : 'ðŸ”Š Mute';
        });

        infoDiv.appendChild(usernameSpan);
        infoDiv.appendChild(muteBtn);
        infoDiv.appendChild(shareBtn);

        // Caption below
        const captionP = document.createElement('p');
        captionP.classList.add('caption');
        captionP.textContent = data.caption || '';

        // Comments Section
        const commentSection = document.createElement('div');
        commentSection.classList.add('comment-section');

        const commentsList = document.createElement('div');
        commentsList.classList.add('comments-list');
        commentsList.textContent = 'Loading comments...';

        // Comment input if logged in
        const commentInputDiv = document.createElement('div');
        commentInputDiv.classList.add('comment-input');

        const commentInput = document.createElement('input');
        commentInput.type = 'text';
        commentInput.placeholder = 'Write a comment...';

        const commentBtn = document.createElement('button');
        commentBtn.textContent = 'Send';
        commentBtn.disabled = true;

        commentInput.addEventListener('input', () => {
          commentBtn.disabled = commentInput.value.trim().length === 0;
        });

        commentBtn.addEventListener('click', async () => {
          if (!currentUser) {
            alert('Please login to comment.');
            return;
          }
          const text = commentInput.value.trim();
          if (text.length === 0) return;

          try {
            await addDoc(collection(db, 'posts', id, 'comments'), {
              text,
              userId: currentUser.uid,
              username: currentUser.displayName || currentUser.email || 'Anonymous',
              createdAt: serverTimestamp()
            });
            commentInput.value = '';
            commentBtn.disabled = true;
          } catch (error) {
            alert('Error adding comment: ' + error.message);
          }
        });

        commentInputDiv.appendChild(commentInput);
        commentInputDiv.appendChild(commentBtn);

        commentSection.appendChild(commentsList);
        if (currentUser) {
          commentSection.appendChild(commentInputDiv);
        }

        // Append all parts to container
        container.appendChild(video);
        container.appendChild(infoDiv);
        container.appendChild(captionP);
        container.appendChild(commentSection);

        clixList.appendChild(container);

        // Load comments live
        const commentsRef = collection(db, 'posts', id, 'comments');
        const commentsQuery = query(commentsRef, orderBy('createdAt', 'asc'));

        onSnapshot(commentsQuery, commentsSnap => {
          commentsList.innerHTML = '';
          if (commentsSnap.empty) {
            commentsList.textContent = 'No comments yet. Be the first!';
            return;
          }
          commentsSnap.forEach(cdoc => {
            const cdata = cdoc.data();
            const cDiv = document.createElement('div');
            cDiv.classList.add('comment-item');
            cDiv.innerHTML = `<span class="comment-author">@${cdata.username || 'anon'}</span>: <span class="comment-text">${escapeHtml(cdata.text)}</span>`;
            commentsList.appendChild(cDiv);
          });
        });
      });
    });

    // Simple HTML escape for comment text
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m]);
    }
  </script>

</body>
</html>

