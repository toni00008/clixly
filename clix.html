<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clix â€¢ Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .feed-container {
      flex: 1;
      overflow-y: auto;
      scroll-behavior: smooth;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .post {
      position: relative;
      max-width: 500px;
      margin: 0 auto;
      aspect-ratio: 9 / 16;
      background: #111;
      overflow: hidden;
      border-radius: 16px;
      box-shadow: 0 0 15px #ff0050;
    }

    .media {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .username-overlay {
      position: absolute;
      top: 10px;
      left: 12px;
      z-index: 2;
      font-weight: 700;
      font-size: 1em;
      color: rgba(255,255,255,0.9);
      text-shadow: 0 0 5px rgba(0,0,0,0.7);
    }

    .actions {
      position: absolute;
      right: 12px;
      bottom: 12px;
      z-index: 2;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .action-btn {
      font-size: 1.5em;
      background: rgba(0,0,0,0.4);
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    .like-count {
      font-size: 0.85em;
      text-align: center;
      color: #ff0050;
    }

    .caption {
      text-align: center;
      padding: 6px;
      color: #ccc;
      font-size: 0.9em;
    }

    .upload-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ff0050;
      color: white;
      font-size: 2em;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      z-index: 10;
      cursor: pointer;
      box-shadow: 0 0 10px #ff0050;
    }

    .comment-popup {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      max-height: 60%;
      background: rgba(0,0,0,0.95);
      border-top: 2px solid #ff0050;
      overflow-y: auto;
      z-index: 100;
      padding: 10px;
      display: none;
    }

    .comment-popup.active {
      display: block;
    }

    .comment {
      margin-bottom: 10px;
      border-bottom: 1px solid #333;
      padding-bottom: 4px;
    }

    .comment-input {
      width: 100%;
      display: flex;
      margin-top: 10px;
      gap: 6px;
    }

    .comment-input input {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: none;
    }

    .comment-input button {
      background: #ff0050;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<div class="feed-container" id="feed"></div>
<div class="comment-popup" id="commentPopup">
  <div id="commentList"></div>
  <div class="comment-input">
    <input type="text" id="commentInput" placeholder="Write a comment..." />
    <button id="submitComment">Post</button>
  </div>
</div>

<button class="upload-btn" onclick="location.href='upload.html'">ï¼‹</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, query, orderBy, limit, startAfter, getDocs, doc,
  updateDoc, increment, addDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
  authDomain: "clixly-bc284.firebaseapp.com",
  projectId: "clixly-bc284",
  storageBucket: "clixly-bc284.appspot.com",
  messagingSenderId: "33343695899",
  appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
let currentUsername = null;

onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    const userDoc = await getDocs(query(collection(db, "users")));
    userDoc.forEach(docSnap => {
      if (docSnap.id === user.uid) {
        currentUsername = docSnap.data().username || "user";
      }
    });
  }
});

const feed = document.getElementById("feed");
const commentPopup = document.getElementById("commentPopup");
const commentList = document.getElementById("commentList");
const commentInput = document.getElementById("commentInput");
const submitComment = document.getElementById("submitComment");

let lastVisible = null;
let currentPostId = null;

async function loadFeed(initial = false) {
  const q = initial
    ? query(collection(db, "clixPosts"), orderBy("createdAt", "desc"), limit(5))
    : query(collection(db, "clixPosts"), orderBy("createdAt", "desc"), startAfter(lastVisible), limit(5));
  const snapshot = await getDocs(q);
  if (snapshot.empty) return;

  lastVisible = snapshot.docs[snapshot.docs.length - 1];

  snapshot.forEach(docSnap => {
    const post = docSnap.data();
    const postId = docSnap.id;

    const postEl = document.createElement("div");
    postEl.className = "post";

    const video = document.createElement("video");
    video.src = post.mediaURL;
    video.autoplay = true;
    video.loop = true;
    video.muted = true;
    video.playsInline = true;
    video.className = "media";
    video.addEventListener("click", () => {
      video.muted = !video.muted;
    });

    const usernameOverlay = document.createElement("div");
    usernameOverlay.className = "username-overlay";
    usernameOverlay.textContent = `@${post.username || 'user'}`;

    const actions = document.createElement("div");
    actions.className = "actions";

    const likeBtn = document.createElement("button");
    likeBtn.className = "action-btn";
    likeBtn.textContent = "â¤ï¸";

    const commentBtn = document.createElement("button");
    commentBtn.className = "action-btn";
    commentBtn.textContent = "ðŸ’¬";

    const saveBtn = document.createElement("button");
    saveBtn.className = "action-btn";
    saveBtn.textContent = "ðŸ”–";

    const likeCount = document.createElement("div");
    likeCount.className = "like-count";
    likeCount.textContent = post.likes || 0;

    likeBtn.onclick = async () => {
      await updateDoc(doc(db, "clixPosts", postId), { likes: increment(1) });
      likeCount.textContent = parseInt(likeCount.textContent) + 1;
    };

    commentBtn.onclick = () => {
      openComments(postId);
    };

    actions.append(likeBtn, commentBtn, saveBtn, likeCount);

    const caption = document.createElement("div");
    caption.className = "caption";
    caption.textContent = post.caption || "";

    postEl.append(video, usernameOverlay, actions, caption);
    feed.appendChild(postEl);
  });
}

function openComments(postId) {
  currentPostId = postId;
  commentPopup.classList.add("active");
  commentList.innerHTML = "<p style='text-align:center;'>Loading comments...</p>";

  const commentsRef = collection(db, "clixPosts", postId, "comments");
  onSnapshot(query(commentsRef, orderBy("createdAt", "desc")), (snapshot) => {
    commentList.innerHTML = "";
    snapshot.forEach(docSnap => {
      const c = docSnap.data();
      const cEl = document.createElement("div");
      cEl.className = "comment";
      cEl.innerHTML = `<strong>@${c.username || 'anon'}</strong>: ${c.text}`;
      commentList.appendChild(cEl);
    });
  });
}

submitComment.onclick = async () => {
  const text = commentInput.value.trim();
  if (!text || !currentUser || !currentPostId) return;

  await addDoc(collection(db, "clixPosts", currentPostId, "comments"), {
    text,
    username: currentUsername || "user",
    createdAt: new Date()
  });
  commentInput.value = "";
};

// Initial load
loadFeed(true);

// Infinite scroll
feed.addEventListener('scroll', () => {
  if (feed.scrollTop + feed.clientHeight >= feed.scrollHeight - 50) {
    loadFeed();
  }
});
</script>

</body>
</html>

