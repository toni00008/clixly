<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clixly • Upload</title>
  <style>
    body {
      font-family: sans-serif;
      background: #0d0d10;
      color: white;
      padding: 20px;
    }
    input, textarea, button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
    }
    button {
      background-color: #8a2be2;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #thumbnail-preview {
      display: none;
      width: 100%;
      margin-top: 10px;
      border-radius: 10px;
    }
    #progress-bar {
      width: 100%;
      height: 10px;
      background: #333;
      border-radius: 10px;
      margin-top: 10px;
      overflow: hidden;
    }
    #progress-fill {
      height: 100%;
      width: 0%;
      background: limegreen;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <h2>Upload a Video to Clixly</h2>

  <input type="file" id="videoFile" accept="video/*" />
  <video id="thumbnail-preview" controls></video>

  <input type="text" id="title" placeholder="Title" />
  <textarea id="description" placeholder="Write a description..."></textarea>
  <input type="text" id="hashtags" placeholder="#tags, #hashtag, #coolvideo" />
  <input type="text" id="location" placeholder="Location (optional)" />
  <input type="text" id="taggedFriends" placeholder="Tag Friends (comma-separated usernames)" />
  <label for="schedule">Schedule Post (Optional):</label>
  <input type="datetime-local" id="schedule" />
  
  <div id="progress-bar"><div id="progress-fill"></div></div>
  
  <button id="uploadBtn">Upload</button>
  <button id="saveDraftBtn">Save as Draft</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ✅ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
      authDomain: "clixly-bc284.firebaseapp.com",
      projectId: "clixly-bc284",
      storageBucket: "clixly-bc284.appspot.com",
      messagingSenderId: "33343695899",
      appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const cloudinaryURL = "https://api.cloudinary.com/v1_1/dd1xg9duv/video/upload";
    const uploadPreset = "clixly_upload";

    const videoInput = document.getElementById("videoFile");
    const preview = document.getElementById("thumbnail-preview");
    const progressFill = document.getElementById("progress-fill");

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("Please log in to upload.");
        window.location.href = "login.html";
      } else {
        currentUser = user;
      }
    });

    videoInput.onchange = () => {
      const file = videoInput.files[0];
      if (file && file.size <= 300 * 1024 * 1024) {
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
      } else {
        alert("Max file size is 5 minutes or ~300MB.");
        videoInput.value = '';
      }
    };

    async function uploadToCloudinary(file) {
      return new Promise((resolve, reject) => {
        const form = new FormData();
        form.append("file", file);
        form.append("upload_preset", uploadPreset);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", cloudinaryURL);
        
        xhr.upload.onprogress = (e) => {
          const percent = (e.loaded / e.total) * 100;
          progressFill.style.width = `${percent}%`;
        };

        xhr.onload = () => {
          const res = JSON.parse(xhr.responseText);
          if (res.secure_url) resolve(res.secure_url);
          else reject("Upload failed");
        };

        xhr.onerror = () => reject("Upload error");
        xhr.send(form);
      });
    }

    async function handleUpload(isDraft = false) {
      const file = videoInput.files[0];
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const hashtags = document.getElementById("hashtags").value.trim().split(",").map(x => x.trim());
      const location = document.getElementById("location").value.trim();
      const taggedFriends = document.getElementById("taggedFriends").value.trim().split(",").map(x => x.trim());
      const schedule = document.getElementById("schedule").value;

      if (!file || !title) return alert("Please select video and title.");

      try {
        const videoUrl = await uploadToCloudinary(file);

        await addDoc(collection(db, "posts"), {
          userId: currentUser.uid,
          title,
          description,
          hashtags,
          location,
          taggedFriends,
          scheduledAt: schedule || null,
          isDraft,
          videoUrl,
          createdAt: serverTimestamp()
        });

        alert(isDraft ? "Draft saved!" : "Upload successful!");
        window.location.href = isDraft ? "drafts.html" : "index.html";

      } catch (err) {
        console.error(err);
        alert("Upload failed.");
      }
    }

    document.getElementById("uploadBtn").onclick = () => handleUpload(false);
    document.getElementById("saveDraftBtn").onclick = () => handleUpload(true);
  </script>
</body>
</html>


