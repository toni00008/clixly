<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Clix â€¢ Upload</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f0f0;
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
  }

  .upload-container {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    max-width: 500px;
    width: 100%;
  }

  h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #333;
  }

  video, img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
    object-fit: contain;
  }

  input[type="file"], textarea, button {
    width: 100%;
    margin: 10px 0;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1em;
  }

  textarea {
    resize: none;
    height: 100px;
  }

  #charCount {
    text-align: right;
    font-size: 0.85em;
    color: #555;
  }

  button {
    background-color: #ff0050;
    color: white;
    font-weight: bold;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  button:hover:enabled {
    background-color: #e60044;
  }

  #status {
    margin-top: 10px;
    text-align: center;
    font-size: 0.95em;
    color: #333;
  }
</style>
</head>
<body>

<div class="upload-container">
  <h2>ðŸ“¤ Upload Post</h2>
  <video id="previewVideo" controls muted></video>
  <img id="previewImage" alt="Preview Image" />
  <input type="file" id="mediaInput" accept="video/*,image/*" />
  <textarea id="caption" placeholder="Write a caption... (Max 300 chars)"></textarea>
  <div id="charCount">0 / 300</div>
  <button id="uploadBtn" disabled>ðŸš€ Upload</button>
  <div id="status"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
    authDomain: "clixly-bc284.firebaseapp.com",
    projectId: "clixly-bc284",
    storageBucket: "clixly-bc284.appspot.com",
    messagingSenderId: "33343695899",
    appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const mediaInput = document.getElementById("mediaInput");
  const captionInput = document.getElementById("caption");
  const uploadBtn = document.getElementById("uploadBtn");
  const statusDiv = document.getElementById("status");
  const previewImage = document.getElementById("previewImage");
  const previewVideo = document.getElementById("previewVideo");
  const charCount = document.getElementById("charCount");

  let currentUser = null;
  let selectedFile = null;
  let selectedType = null;

  // Cloudinary info
  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dd1xg9duv/upload";
  const CLOUDINARY_UPLOAD_PRESET = "clixly_upload";

  onAuthStateChanged(auth, user => {
    if (!user) {
      statusDiv.innerHTML = 'Please <a href="login.html">login</a> to upload posts.';
      uploadBtn.disabled = true;
      return;
    }
    currentUser = user;
    uploadBtn.disabled = false;
    statusDiv.textContent = '';
  });

  mediaInput.addEventListener("change", () => {
    const file = mediaInput.files[0];
    if (!file) {
      previewImage.style.display = "none";
      previewVideo.style.display = "none";
      uploadBtn.disabled = true;
      selectedFile = null;
      return;
    }

    selectedFile = file;
    selectedType = file.type.startsWith("video/") ? "video" : "image";

    if(selectedType === "video") {
      previewImage.style.display = "none";
      previewVideo.style.display = "block";
      previewVideo.src = URL.createObjectURL(file);
      previewVideo.load();
      previewVideo.play();
    } else {
      previewVideo.style.display = "none";
      previewImage.style.display = "block";
      previewImage.src = URL.createObjectURL(file);
    }

    uploadBtn.disabled = false;
  });

  captionInput.addEventListener("input", () => {
    const len = captionInput.value.length;
    charCount.textContent = `${len} / 300`;
    if (len > 300) {
      captionInput.style.borderColor = "red";
      uploadBtn.disabled = true;
    } else {
      captionInput.style.borderColor = "#ccc";
      if(selectedFile) uploadBtn.disabled = false;
    }
  });

  uploadBtn.addEventListener("click", async () => {
    if (!selectedFile) {
      alert("Select a media file before uploading.");
      return;
    }
    if (captionInput.value.length > 300) {
      alert("Caption too long. Max 300 characters.");
      return;
    }
    uploadBtn.disabled = true;
    statusDiv.textContent = "Uploading...";

    try {
      const formData = new FormData();
      formData.append("file", selectedFile);
      formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      const response = await fetch(CLOUDINARY_URL, {
        method: "POST",
        body: formData,
      });

      if (!response.ok) throw new Error("Upload failed.");

      const data = await response.json();
      const mediaURL = data.secure_url;

      await addDoc(collection(db, "clixPosts"), {
        mediaURL,
        caption: captionInput.value.trim(),
        type: selectedType,
        userEmail: currentUser.email,
        createdAt: serverTimestamp(),
      });

      statusDiv.textContent = "âœ… Upload successful!";
      mediaInput.value = "";
      captionInput.value = "";
      previewImage.style.display = "none";
      previewVideo.style.display = "none";
      charCount.textContent = "0 / 300";
      uploadBtn.disabled = true;

    } catch (err) {
      alert("Upload failed: " + err.message);
      statusDiv.textContent = "";
      uploadBtn.disabled = false;
    }
  });
</script>
</body>
</html>


