<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clixly â€¢ Feed</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: auto;
      background: #f9f9f9;
      padding: 20px;
    }
    .post {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      padding: 16px;
      transition: transform 0.2s;
    }
    .post:hover {
      transform: translateY(-3px);
    }
    .post img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    .user {
      color: #0077ff;
      font-weight: bold;
      cursor: pointer;
    }
    .caption {
      margin-top: 10px;
      font-size: 1em;
    }
    button.follow-btn {
      margin-top: 10px;
      padding: 6px 12px;
      background: #0077ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Clixly Feed</h2>
  <div id="posts">Loading posts...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc,
      updateDoc, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
      authDomain: "clixly-bc284.firebaseapp.com",
      projectId: "clixly-bc284",
      storageBucket: "clixly-bc284.appspot.com",
      messagingSenderId: "33343695899",
      appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const postsDiv = document.getElementById('posts');
    let currentUser = null;
    let usersCache = {}; // userId -> userData

    onAuthStateChanged(auth, async user => {
      if (!user) {
        postsDiv.innerHTML = 'Please <a href="login.html">login</a> to view posts.';
        return;
      }
      currentUser = user;
      loadUsersCache().then(() => loadPosts());
    });

    // Preload all users to cache username and followers info
    async function loadUsersCache() {
      const usersCol = collection(db, 'users');
      const usersSnap = await getDocs(usersCol);
      usersSnap.forEach(doc => {
        usersCache[doc.id] = doc.data();
      });
    }

    function loadPosts() {
      const postsQuery = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));

      onSnapshot(postsQuery, async snapshot => {
        postsDiv.innerHTML = '';
        for (const postDoc of snapshot.docs) {
          const post = postDoc.data();
          const postId = postDoc.id;
          const userId = post.userId;

          const userData = usersCache[userId] || { username: 'Unknown' };

          // Check if current user follows post author
          const currentUserData = usersCache[currentUser.uid] || { following: [] };
          const isFollowing = (currentUserData.following || []).includes(userId);

          const postEl = document.createElement('div');
          postEl.className = 'post';

          postEl.innerHTML = `
            <div>
              <a href="profile.html?id=${userId}" class="user">${userData.username}</a>
            </div>
            <img src="${post.imageURL}" alt="Post image" />
            <div class="caption">${post.caption || ''}</div>
            <button class="follow-btn">${isFollowing ? 'Unfollow' : 'Follow'}</button>
          `;

          const followBtn = postEl.querySelector('.follow-btn');
          followBtn.onclick = () => toggleFollow(userId);

          postsDiv.appendChild(postEl);
        }
      });
    }

    async function toggleFollow(targetUserId) {
      if (!currentUser) return;

      const currentUserRef = doc(db, 'users', currentUser.uid);
      const targetUserRef = doc(db, 'users', targetUserId);

      const currentUserData = usersCache[currentUser.uid] || { following: [] };
      const targetUserData = usersCache[targetUserId] || { followers: [] };

      const isFollowing = (currentUserData.following || []).includes(targetUserId);

      if (isFollowing) {
        // Unfollow: remove from current user's following and target's followers
        await updateDoc(currentUserRef, {
          following: arrayRemove(targetUserId)
        });
        await updateDoc(targetUserRef, {
          followers: arrayRemove(currentUser.uid)
        });

        // Update cache locally
        usersCache[currentUser.uid].following = usersCache[currentUser.uid].following.filter(uid => uid !== targetUserId);
        usersCache[targetUserId].followers = usersCache[targetUserId].followers.filter(uid => uid !== currentUser.uid);
      } else {
        // Follow: add to current user's following and target's followers
        await updateDoc(currentUserRef, {
          following: arrayUnion(targetUserId)
        });
        await updateDoc(targetUserRef, {
          followers: arrayUnion(currentUser.uid)
        });

        // Update cache locally
        usersCache[currentUser.uid].following = [...(usersCache[currentUser.uid].following || []), targetUserId];
        usersCache[targetUserId].followers = [...(usersCache[targetUserId].followers || []), currentUser.uid];
      }

      loadPosts(); // Refresh posts to update buttons
    }

  </script>
</body>
</html>

