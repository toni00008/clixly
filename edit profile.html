<!DOCTYPE html>
<html>
<head>
  <title>User Profile â€¢ Clixly</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: auto;
      background: #121212;
      color: #eee;
      padding: 20px;
    }
    img.profile-pic {
      width: 150px;
      border-radius: 50%;
      display: block;
      margin: 20px auto;
      border: 3px solid #8a2be2;
      object-fit: cover;
    }
    h1, p.bio {
      text-align: center;
    }
    .posts {
      margin-top: 30px;
    }
    .post {
      background: #222;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 10px;
    }
    .post time {
      font-size: 0.8em;
      color: #888;
    }
    button.edit-btn {
      display: block;
      margin: 20px auto;
      background: #8a2be2;
      border: none;
      padding: 10px 25px;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <img id="profilePic" src="https://via.placeholder.com/150?text=User" alt="Profile Picture" class="profile-pic" />
  <h1 id="username">Loading...</h1>
  <p class="bio" id="bio"></p>

  <button id="editBtn" class="edit-btn" style="display:none;">Edit Profile</button>

  <div class="posts">
    <h2>User Posts</h2>
    <div id="postsContainer">Loading posts...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
      authDomain: "clixly-bc284.firebaseapp.com",
      projectId: "clixly-bc284",
      storageBucket: "clixly-bc284.appspot.com",
      messagingSenderId: "33343695899",
      appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    function getQueryParams() {
      const params = {};
      location.search.slice(1).split("&").forEach(pair => {
        const [key, val] = pair.split("=");
        params[key] = decodeURIComponent(val);
      });
      return params;
    }
    const params = getQueryParams();
    const uid = params.uid;

    const profilePicEl = document.getElementById("profilePic");
    const usernameEl = document.getElementById("username");
    const bioEl = document.getElementById("bio");
    const postsContainer = document.getElementById("postsContainer");
    const editBtn = document.getElementById("editBtn");

    if (!uid) {
      alert("User ID missing in URL");
      window.location.href = "index.html";
    }

    async function loadUser() {
      const userDoc = doc(db, "users", uid);
      const userSnap = await getDoc(userDoc);

      if (userSnap.exists()) {
        const data = userSnap.data();
        profilePicEl.src = data.profilePic || "https://via.placeholder.com/150?text=User";
        usernameEl.textContent = data.username || "No username";
        bioEl.textContent = data.bio || "";
      } else {
        alert("User not found");
        window.location.href = "index.html";
      }
    }

    async function loadPosts() {
      postsContainer.textContent = "Loading posts...";
      const postsQuery = query(
        collection(db, "posts"),
        where("userId", "==", uid),
        orderBy("createdAt", "desc")
      );

      try {
        const snapshot = await getDocs(postsQuery);
        if (snapshot.empty) {
          postsContainer.textContent = "No posts yet.";
          return;
        }

        postsContainer.innerHTML = "";
        snapshot.forEach(docSnap => {
          const post = docSnap.data();
          const postDiv = document.createElement("div");
          postDiv.className = "post";

          const postText = post.text || "(No content)";
          const postDate = post.createdAt ? new Date(post.createdAt.seconds * 1000) : new Date();

          postDiv.innerHTML = `
            <p>${escapeHtml(postText)}</p>
            <time>${postDate.toLocaleString()}</time>
          `;

          postsContainer.appendChild(postDiv);
        });
      } catch (e) {
        postsContainer.textContent = "Error loading posts: " + e.message;
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, function(m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
      });
    }

    // Show Edit button if logged in user matches profile uid
    onAuthStateChanged(auth, (user) => {
      if (user && user.uid === uid) {
        editBtn.style.display = "block";
        editBtn.onclick = () => {
          window.location.href = "edit-profile.html";
        };
      }
    });

    // Init
    loadUser();
    loadPosts();
  </script>

</body>
</html>
