<!DOCTYPE html>
<html>
<head>
  <title>Clixly • Explore</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 700px;
      margin: auto;
      background: #f5f5f5;
      padding: 20px;
    }
    nav a {
      margin-right: 15px;
      color: #0077ff;
      text-decoration: none;
    }
    .post-card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .post-card img {
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    .username {
      font-weight: bold;
      color: #333;
      cursor: pointer;
    }
    .comment {
      margin-top: 5px;
      font-size: 0.9em;
      background: #f0f0f0;
      padding: 6px;
      border-radius: 6px;
    }
    .hashtag {
      background: #e0f0ff;
      color: #0077ff;
      padding: 4px 6px;
      border-radius: 4px;
      display: inline-block;
      margin: 4px 4px 0 0;
    }
    input, button {
      margin-top: 10px;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #0077ff;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav>
    <a href="feed.html">Feed</a>
    <a href="explore.html">Explore</a>
    <a href="profile.html">Profile</a>
  </nav>

  <h2>Explore</h2>
  <input type="text" id="searchInput" placeholder="Search posts or hashtags..." />

  <div id="posts">Loading...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs,
      onSnapshot, orderBy, query, updateDoc, arrayUnion,
      setDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
      authDomain: "clixly-bc284.firebaseapp.com",
      projectId: "clixly-bc284",
      storageBucket: "clixly-bc284.appspot.com",
      messagingSenderId: "33343695899",
      appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const postsEl = document.getElementById("posts");
    const searchInput = document.getElementById("searchInput");

    let posts = [];
    const userCache = {};

    function renderPosts(filter = '') {
      postsEl.innerHTML = '';

      const filtered = posts.filter(p =>
        p.caption.toLowerCase().includes(filter) ||
        (p.caption.match(/#\w+/g) || []).some(tag => tag.toLowerCase().includes(filter))
      );

      (filtered.length ? filtered : posts).forEach(p => {
        const div = document.createElement('div');
        div.className = 'post-card';

        const hashtags = p.caption.match(/#\w+/g) || [];

        div.innerHTML = `
          <div class="username" onclick="location.href='profile.html?id=${p.userId}'">@${p.username}</div>
          <img src="${p.imageURL}" />
          <div>${p.caption}</div>
          <div>${hashtags.map(tag => `<span class="hashtag">${tag}</span>`).join(' ')}</div>
          <div>❤️ ${p.likes.length}</div>
          <button onclick="likePost('${p.id}')">Like</button>
          <div id="comments-${p.id}">Loading comments...</div>
          <input type="text" id="comment-input-${p.id}" placeholder="Add comment..."/>
          <button onclick="addComment('${p.id}')">Comment</button>
        `;

        postsEl.appendChild(div);

        loadComments(p.id);
      });
    }

    onAuthStateChanged(auth, async user => {
      if (!user) {
        postsEl.innerHTML = "Please <a href='login.html'>log in</a>.";
        return;
      }

      const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
      onSnapshot(q, async snapshot => {
        posts = [];

        for (let docSnap of snapshot.docs) {
          const post = docSnap.data();
          post.id = docSnap.id;
          post.likes = post.likes || [];

          // Get username
          if (!userCache[post.userEmail]) {
            const uDoc = await getDoc(doc(db, "users", post.userEmail));
            userCache[post.userEmail] = uDoc.exists() ? uDoc.data().username : post.userEmail;
          }
          post.username = userCache[post.userEmail];
          post.userId = post.userEmail;

          posts.push(post);
        }

        renderPosts(searchInput.value.toLowerCase());
      });
    });

    async function likePost(postId) {
      const user = auth.currentUser;
      if (!user) return;

      const postRef = doc(db, "posts", postId);
      await updateDoc(postRef, {
        likes: arrayUnion(user.uid)
      });
    }

    async function addComment(postId) {
      const user = auth.currentUser;
      if (!user) return;

      const input = document.getElementById(`comment-input-${postId}`);
      const text = input.value.trim();
      if (!text) return;

      const commentRef = doc(collection(db, "posts", postId, "comments"));
      await setDoc(commentRef, {
        userEmail: user.email,
        text,
        createdAt: new Date()
      });

      input.value = '';
    }

    function loadComments(postId) {
      const commentsRef = collection(db, "posts", postId, "comments");
      const commentsDiv = document.getElementById(`comments-${postId}`);

      onSnapshot(commentsRef, snap => {
        commentsDiv.innerHTML = '';
        snap.forEach(docSnap => {
          const c = docSnap.data();
          const div = document.createElement('div');
          div.className = 'comment';
          div.innerHTML = `<b>${c.userEmail}</b>: ${c.text}`;
          commentsDiv.appendChild(div);
        });
      });
    }

    searchInput.oninput = e => renderPosts(e.target.value.toLowerCase());
  </script>
</body>
</html>

