<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clixly ‚Ä¢ Explore</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f8;
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
      color: #222;
    }
    nav {
      margin-bottom: 20px;
    }
    nav a {
      margin-right: 20px;
      text-decoration: none;
      color: #0077ff;
      font-weight: 600;
    }
    nav a:hover {
      text-decoration: underline;
    }
    h2 {
      margin-bottom: 15px;
    }
    #searchInput {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
      box-sizing: border-box;
    }
    .post-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgb(0 0 0 / 0.1);
      margin-bottom: 25px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .post-username {
      font-weight: 700;
      font-size: 1.1em;
      color: #0077ff;
    }
    .post-image {
      width: 100%;
      border-radius: 8px;
      object-fit: cover;
      max-height: 400px;
    }
    .post-caption {
      white-space: pre-wrap;
      font-size: 1em;
      line-height: 1.3;
    }
    .hashtags {
      margin-top: 6px;
    }
    .hashtag {
      display: inline-block;
      background: #e0f2ff;
      color: #0077ff;
      padding: 4px 10px;
      margin-right: 8px;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .hashtag:hover {
      background-color: #a3d1ff;
    }
    .actions {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .like-btn, .comment-btn {
      cursor: pointer;
      font-size: 1.1em;
      border: none;
      background: none;
      user-select: none;
      padding: 6px 10px;
      border-radius: 6px;
      transition: background-color 0.3s ease;
    }
    .like-btn:hover {
      background-color: #ffe0e6;
    }
    .like-btn.liked {
      color: #e0245e;
      font-weight: 700;
    }
    .comment-btn:hover {
      background-color: #d0e6ff;
    }
    .stats {
      font-size: 0.9em;
      color: #666;
      user-select: none;
    }
    .loading {
      text-align: center;
      font-size: 1.2em;
      color: #888;
      margin-top: 40px;
    }
  </style>
</head>
<body>

  <nav>
    <a href="feed.html">Feed</a>
    <a href="explore.html">Explore</a>
    <a href="profile.html">Profile</a>
  </nav>

  <h2>Explore</h2>
  <input type="search" id="searchInput" placeholder="Search posts or hashtags..." autocomplete="off" spellcheck="false" />

  <div id="posts" class="loading">Loading posts...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy,
      onSnapshot, doc, getDoc,
      updateDoc, arrayUnion, arrayRemove,
      collectionGroup, addDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
      authDomain: "clixly-bc284.firebaseapp.com",
      projectId: "clixly-bc284",
      storageBucket: "clixly-bc284.appspot.com",
      messagingSenderId: "33343695899",
      appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const postsEl = document.getElementById('posts');
    const searchInput = document.getElementById('searchInput');

    // State
    let posts = [];
    const userCache = {};  // email => username
    let currentUserEmail = null;

    // Monitor auth state
    onAuthStateChanged(auth, user => {
      currentUserEmail = user?.email || null;
      renderPosts(searchInput.value.trim().toLowerCase());
    });

    // Listen for posts in Firestore ordered by createdAt desc
    const postsQuery = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));

    onSnapshot(postsQuery, async snapshot => {
      posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      // Fetch and cache usernames for all userEmails
      await Promise.all(posts.map(async post => {
        if (!userCache[post.userEmail]) {
          try {
            const userDoc = await getDoc(doc(db, 'users', post.userEmail));
            userCache[post.userEmail] = userDoc.exists() ? userDoc.data().username : post.userEmail;
          } catch {
            userCache[post.userEmail] = post.userEmail;
          }
        }
        post.username = userCache[post.userEmail];
        if (!Array.isArray(post.likes)) post.likes = [];
      }));

      renderPosts(searchInput.value.trim().toLowerCase());
    }, error => {
      postsEl.textContent = 'Failed to load posts. Please try again later.';
      console.error("Firestore posts error:", error);
    });

    // Search input event
    searchInput.addEventListener('input', e => {
      renderPosts(e.target.value.trim().toLowerCase());
    });

    // Render posts with filter
    function renderPosts(filter = '') {
      postsEl.innerHTML = '';
      if (!posts.length) {
        postsEl.textContent = 'No posts to display.';
        return;
      }

      // Filter posts by caption or hashtags
      const filtered = posts.filter(post => {
        const caption = post.caption?.toLowerCase() || '';
        const hashtags = (post.caption?.match(/#\w+/g) || []).map(t => t.toLowerCase());
        if (!filter) return true;
        if (caption.includes(filter)) return true;
        if (filter.startsWith('#')) {
          return hashtags.some(tag => tag === filter);
        }
        return hashtags.some(tag => tag.includes(filter));
      });

      if (!filtered.length) {
        postsEl.textContent = 'No posts match your search.';
        return;
      }

      for (const post of filtered) {
        const div = document.createElement('div');
        div.className = 'post-card';

        const hashtags = (post.caption?.match(/#\w+/g) || []);

        // Is current user liked this post?
        const liked = currentUserEmail && post.likes.includes(currentUserEmail);

        div.innerHTML = `
          <div class="post-username">${escapeHTML(post.username)}</div>
          <img class="post-image" src="${escapeHTML(post.imageURL)}" alt="Post Image" loading="lazy" />
          <div class="post-caption">${escapeHTML(post.caption)}</div>
          <div class="hashtags">${hashtags.map(tag => `<span class="hashtag" onclick="searchHashtag('${tag.toLowerCase()}')">${escapeHTML(tag)}</span>`).join('')}</div>
          <div class="actions">
            <button class="like-btn ${liked ? 'liked' : ''}" aria-label="Like button">${liked ? '‚ù§Ô∏è' : 'ü§ç'} Like (${post.likes.length})</button>
            <button class="comment-btn" aria-label="Comment button">üí¨ Comment</button>
          </div>
          <div class="stats" id="comments-count-${post.id}">Comments: Loading...</div>
        `;

        postsEl.appendChild(div);

        // Like button event
        div.querySelector('.like-btn').onclick = () => toggleLike(post.id, post.likes);

        // Comment button event
        div.querySelector('.comment-btn').onclick = () => addComment(post.id);

        loadCommentsCount(post.id).catch(console.error);
      }
    }

    // Escape HTML to prevent injection
    function escapeHTML(text) {
      if (!text) return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Search posts by hashtag click
    window.searchHashtag = function(tag) {
      searchInput.value = tag;
      renderPosts(tag);
    }

    // Toggle like/unlike on a post
    async function toggleLike(postId, likes) {
      if (!currentUserEmail) {
        alert('Please log in to like posts.');
        return;
      }
      const postRef = doc(db, 'posts', postId);
      try {
        if (likes.includes(currentUserEmail)) {
          await updateDoc(postRef, { likes: arrayRemove(currentUserEmail) });
        } else {
          await updateDoc(postRef, { likes: arrayUnion(currentUserEmail) });
        }
      } catch (err) {
        console.error('Error toggling like:', err);
        alert('Could not update like. Please try again.');
      }
    }

    // Add comment to a post
    async function addComment(postId) {
      if (!currentUserEmail) {
        alert('Please log in to comment.');
        return;
      }
      const commentText = prompt('Write your comment:');
      if (!commentText || !commentText.trim()) return;

      try {
        const commentsRef = collection(db, 'posts', postId, 'comments');
        await addDoc(commentsRef, {
          userEmail: currentUserEmail,
          text: commentText.trim(),
          createdAt: new Date()
        });
        alert('Comment added!');
        loadCommentsCount(postId);
      } catch (err) {
        console.error('Error adding comment:', err);
        alert('Could not add comment. Please try again.');
      }
    }

    // Load comment count for a post and update UI
    async function loadCommentsCount(postId) {
      try {
        const commentsRef = collection(db, 'posts', postId, 'comments');
        const commentsSnap = await getDocs(commentsRef);
        const countEl = document.getElementById(`comments-count-${postId}`);
        if (countEl) countEl.textContent = `Comments: ${commentsSnap.size}`;
      } catch (err) {
        console.error('Error loading comments count:', err);
      }
    }
  </script>
</body>
</html>
