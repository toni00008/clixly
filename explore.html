<!DOCTYPE html>
<html>
<head>
  <title>Clixly Explore</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; max-width: 700px; margin: auto; background: #f9f9f9; padding: 20px; }
    .post { background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; padding: 16px; }
    .post img { width: 100%; border-radius: 10px; }
    .user { color: #0077ff; font-weight: bold; cursor: pointer; }
    .caption { margin-top: 10px; }
    .likes, .comments { margin-top: 10px; font-size: 0.9em; }
    button { margin-top: 5px; padding: 5px 10px; border: none; border-radius: 6px; background: #0077ff; color: white; cursor: pointer; }
    .comment-input { width: 100%; padding: 8px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<h2>üåê Explore Clixly</h2>
<input type="text" id="searchInput" placeholder="üîç Search posts / hashtags..." style="width:100%; padding:10px; border-radius:10px; margin-bottom:20px;">
<div id="posts">Loading...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc, updateDoc, arrayUnion, arrayRemove, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
  authDomain: "clixly-bc284.firebaseapp.com",
  projectId: "clixly-bc284",
  storageBucket: "clixly-bc284.appspot.com",
  messagingSenderId: "33343695899",
  appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const postsDiv = document.getElementById("posts");
const searchInput = document.getElementById("searchInput");
let allPosts = [], userCache = {};

onAuthStateChanged(auth, async user => {
  if (!user) return postsDiv.innerHTML = 'Please <a href="login.html">login</a> to view posts.';

  const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
  onSnapshot(q, async snapshot => {
    postsDiv.innerHTML = "";
    allPosts = [];

    for (const docSnap of snapshot.docs) {
      const post = docSnap.data();
      const postId = docSnap.id;
      const userEmail = post.userEmail || "anonymous";

      if (!userCache[post.userId]) {
        const userDoc = await getDoc(doc(db, 'users', post.userId));
        userCache[post.userId] = userDoc.exists() ? userDoc.data().username : userEmail;
      }

      allPosts.push({ ...post, id: postId, username: userCache[post.userId] });
    }
    renderPosts();
  });
});

function renderPosts(filter = '') {
  postsDiv.innerHTML = '';
  const f = filter.toLowerCase();
  const filtered = allPosts.filter(p => p.caption?.toLowerCase().includes(f));
  (filtered.length ? filtered : allPosts).forEach(post => {
    const postEl = document.createElement("div");
    postEl.className = "post";
    postEl.innerHTML = `
      <div class="user" onclick="goToUser('${post.userId}')">@${post.username}</div>
      <img src="${post.imageURL}" alt="Post">
      <div class="caption">${post.caption}</div>
      <div class="likes">‚ù§Ô∏è Likes: <span id="likes-${post.id}">${post.likes?.length || 0}</span></div>
      <button onclick="likePost('${post.id}', '${auth.currentUser.uid}')">‚ù§Ô∏è Like</button>
      <div class="comments" id="comments-${post.id}">üí¨ Comments loading...</div>
      <input class="comment-input" id="comment-input-${post.id}" placeholder="Add a comment...">
      <button onclick="addComment('${post.id}', '${auth.currentUser.uid}', '${auth.currentUser.email}')">‚ûï Comment</button>
    `;
    postsDiv.appendChild(postEl);

    const commentsRef = collection(db, "posts", post.id, "comments");
    onSnapshot(commentsRef, snapshot => {
      const cDiv = document.getElementById(`comments-${post.id}`);
      cDiv.innerHTML = '';
      snapshot.forEach(doc => {
        const c = doc.data();
        const isOwner = auth.currentUser.uid === c.userId;
        cDiv.innerHTML += `
          <div>
            <b onclick="goToUser('${c.userId}')" style="cursor:pointer;">@${c.userEmail}</b>: ${c.text}
            ${isOwner ? `<button onclick="editComment('${post.id}', '${doc.id}', '${c.text}')">‚úèÔ∏è</button>
            <button onclick="deleteComment('${post.id}', '${doc.id}')">üóëÔ∏è</button>` : ''}
          </div>
        `;
      });
    });
  });
}

searchInput.addEventListener('input', e => renderPosts(e.target.value.trim()));

window.likePost = async function(postId, userId) {
  const ref = doc(db, "posts", postId);
  await updateDoc(ref, { likes: arrayUnion(userId) });
};

window.addComment = async function(postId, userId, email) {
  const input = document.getElementById(`comment-input-${postId}`);
  const text = input.value.trim();
  if (!text) return;
  await setDoc(doc(collection(db, "posts", postId, "comments")), {
    userId, userEmail: email, text, createdAt: new Date()
  });
  input.value = "";
};

window.deleteComment = async function(postId, commentId) {
  if (confirm("Delete comment?")) {
    await deleteDoc(doc(db, "posts", postId, "comments", commentId));
  }
};

window.editComment = async function(postId, commentId, currentText) {
  const newText = prompt("Edit your comment:", currentText);
  if (newText && newText.trim() !== currentText) {
    await updateDoc(doc(db, "posts", postId, "comments", commentId), { text: newText.trim() });
  }
};

window.goToUser = function(userId) {
  window.location.href = `profile.html?id=${userId}`;
};
</script>
</body>
</html>

