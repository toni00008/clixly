<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clixly • Explore</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      max-width: 700px;
      margin: auto;
      background: #f5f5f8;
    }
    nav a {
      margin-right: 15px;
      color: #0077ff;
      text-decoration: none;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    .post-card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 30px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .post-card img {
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    .hashtag {
      display: inline-block;
      background: #e0f2ff;
      color: #0077ff;
      padding: 4px 8px;
      margin-right: 6px;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
    }
    .comments-section {
      margin-top: 15px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    .comment {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
    .comment b {
      margin-right: 6px;
    }
    .like-btn {
      cursor: pointer;
      border: none;
      background: none;
      color: gray;
      font-weight: bold;
      margin-left: 10px;
    }
    .like-btn.liked {
      color: red;
    }
    .add-comment {
      margin-top: 10px;
    }
    .add-comment textarea {
      resize: vertical;
      height: 60px;
    }
    .add-comment button {
      background-color: #0077ff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 5px;
    }
    .add-comment button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <nav>
    <a href="feed.html">Feed</a>
    <a href="explore.html">Explore</a>
    <a href="profile.html">Profile</a>
  </nav>
  <h2>Explore</h2>
  <input type="text" id="searchInput" placeholder="Search posts / hashtags..." />

  <div id="posts">Loading posts...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot,
      doc, getDoc, addDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Your Firebase config here
    const firebaseConfig = {
      apiKey: "AIzaSyDNnoWHDiOUZWMlw-mMdlnDovEDR74zFew",
      authDomain: "clixly-bc284.firebaseapp.com",
      projectId: "clixly-bc284",
      storageBucket: "clixly-bc284.appspot.com",
      messagingSenderId: "33343695899",
      appId: "1:33343695899:web:25b8f943e077dfb1b85cbe"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const postsEl = document.getElementById('posts');
    const searchInput = document.getElementById('searchInput');

    let posts = [];
    const userCache = {}; // email => username
    let currentUserEmail = null;

    onAuthStateChanged(auth, user => {
      currentUserEmail = user ? user.email : null;
      renderPosts(searchInput.value.toLowerCase());
    });

    const postsQuery = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));

    onSnapshot(postsQuery, async snapshot => {
      posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      // Fetch usernames for all posts
      await Promise.all(posts.map(async post => {
        if (!userCache[post.userEmail]) {
          const userDoc = await getDoc(doc(db, 'users', post.userEmail));
          userCache[post.userEmail] = userDoc.exists() ? userDoc.data().username : post.userEmail;
        }
        post.username = userCache[post.userEmail];
      }));

      renderPosts(searchInput.value.toLowerCase());
    });

    searchInput.oninput = e => renderPosts(e.target.value.toLowerCase());

    function renderPosts(filter = '') {
      postsEl.innerHTML = '';

      const filtered = posts.filter(p => {
        const captionLower = p.caption.toLowerCase();
        const hashtags = p.caption.match(/#\w+/g) || [];
        return captionLower.includes(filter) ||
          hashtags.some(tag => tag.toLowerCase().includes(filter)) ||
          (filter.startsWith('#') && hashtags.includes(filter));
      });

      (filtered.length ? filtered : posts).forEach(post => {
        const postDiv = document.createElement('div');
        postDiv.className = 'post-card';

        // Hashtags
        const hashtags = post.caption.match(/#\w+/g) || [];

        postDiv.innerHTML = `
          <div><b>${post.username}</b></div>
          <img src="${post.imageURL}" alt="Post image" />
          <div>${post.caption}</div>
          <div>${hashtags.map(tag => `<span class="hashtag">${tag}</span>`).join('')}</div>
          <div class="comments-section" id="comments-${post.id}">
            <b>Comments:</b>
            <div class="comments-list" id="comments-list-${post.id}">Loading comments...</div>
            <div class="add-comment" id="add-comment-${post.id}">
              <textarea placeholder="Add a comment..." rows="2"></textarea><br>
              <button disabled>Add Comment</button>
            </div>
          </div>
        `;

        postsEl.appendChild(postDiv);

        setupCommentsSection(post.id);
      });
    }

    // Setup comments listener and add comment handler
    function setupCommentsSection(postId) {
      const commentsListEl = document.getElementById(`comments-list-${postId}`);
      const addCommentEl = document.getElementById(`add-comment-${postId}`);
      const textarea = addCommentEl.querySelector('textarea');
      const btn = addCommentEl.querySelector('button');

      if (!currentUserEmail) {
        addCommentEl.style.display = 'none'; // Hide comment input if not logged in
      } else {
        addCommentEl.style.display = 'block';
      }

      textarea.oninput = () => {
        btn.disabled = textarea.value.trim() === '';
      };

      btn.onclick = async () => {
        if (!currentUserEmail) {
          alert('Please log in to comment.');
          return;
        }
        const text = textarea.value.trim();
        if (!text) return;

        btn.disabled = true;

        // Get username for current user from cache or Firestore
        let username = userCache[currentUserEmail];
        if (!username) {
          const userDoc = await getDoc(doc(db, 'users', currentUserEmail));
          username = userDoc.exists() ? userDoc.data().username : currentUserEmail;
          userCache[currentUserEmail] = username;
        }

        try {
          await addDoc(collection(db, 'posts', postId, 'comments'), {
            userEmail: currentUserEmail,
            username: username,
            text: text,
            likes: 0,
            likedBy: [],
            createdAt: serverTimestamp()
          });
          textarea.value = '';
          btn.disabled = true;
        } catch (e) {
          alert('Could not add comment. Please try again.');
          btn.disabled = false;
        }
      };

      // Listen to comments for this post
      const commentsQuery = query(collection(db, 'posts', postId, 'comments'), orderBy('createdAt', 'asc'));
      onSnapshot(commentsQuery, snapshot => {
        commentsListEl.innerHTML = '';
        snapshot.forEach(docSnap => {
          const comment = docSnap.data();
          const commentId = docSnap.id;

          const likes = comment.likes || 0;
          const likedBy = comment.likedBy || [];
          const liked = currentUserEmail && likedBy.includes(currentUserEmail);

          const commentEl = document.createElement('div');
          commentEl.className = 'comment';

          commentEl.innerHTML = `
            <b>${comment.username}</b>: ${comment.text}
            <button class="like-btn ${liked ? 'liked' : ''}" title="Like/Unlike comment">
              ❤️ ${likes}
            </button>
          `;

          // Like button handler
          commentEl.querySelector('button').addEventListener('click', async () => {
            if (!currentUserEmail) {
              alert('Please log in to like comments.');
              return;
            }
            const commentRef = doc(db, 'posts', postId, 'comments', commentId);
            if (liked) {
              // Unlike
              await updateDoc(commentRef, {
                likes: likes - 1,
                likedBy: arrayRemove(currentUserEmail)
              });
            } else {
              // Like
              await updateDoc(commentRef, {
                likes: likes + 1,
                likedBy: arrayUnion(currentUserEmail)
              });
            }
          });

          commentsListEl.appendChild(commentEl);
        });

        if (snapshot.empty) {
          commentsListEl.innerHTML = '<i>No comments yet</i>';
        }
      });
    }
  </script>
</body>
</html>
