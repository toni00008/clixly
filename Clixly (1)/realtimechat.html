<!DOCTYPE html>
<html>
<head>
  <title>Clixly â€¢ Messages</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; max-width:600px; margin:auto; padding:20px; background:#f5f5f8; }
    .chat-list, .chat-box { background:white; border-radius:10px; padding:15px; box-shadow:0 3px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
    .message { margin:8px 0; }
    .message.you { text-align:right; }
    .msg-input { width:calc(100% - 80px); padding:10px; }
    .msg-send { width:60px; padding:10px; }
  </style>
</head>
<body>
  <h2>ðŸ’¬ Messages</h2>
  <div class="chat-list" id="chatList">Loading chats...</div>
  <div class="chat-box" id="chatBox" style="display:none;">
    <h3 id="chatWith">Chat</h3>
    <div id="messages" style="max-height:300px;overflow-y:auto;"></div>
    <div>
      <input id="msgInput" class="msg-input" placeholder="Type...">
      <button class="msg-send" onclick="sendMsg()">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, query, onSnapshot, orderBy, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp({/* config */});
    const auth = getAuth(app);
    const db = getFirestore(app);
    let me;

    onAuthStateChanged(auth, user => {
      if (!user) return window.location='login.html';
      me = user;
      loadChats();
    });

    function loadChats() {
      const q = query(collection(db, 'users', me.uid, 'chats'), orderBy('lastMsg', 'desc'));
      onSnapshot(q, snap => {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = '';
        snap.forEach(d => {
          const c = d.data();
          const el = document.createElement('div');
          el.innerText = c.withName;
          el.style.padding='8px';
          el.style.cursor='pointer';
          el.onclick = ()=> selectChat(d.id, c.withName);
          chatList.appendChild(el);
        });
      });
    }

    let chatId, chatCol;
    function selectChat(otherUid, otherName) {
      chatId = [me.uid, otherUid].sort().join('_');
      document.getElementById('chatWith').innerText = otherName;
      document.getElementById('chatBox').style.display = 'block';

      const ref = collection(db, 'chats', chatId, 'msgs');
      const q = query(ref, orderBy('createdAt'));
      onSnapshot(q, snap => {
        const msgDiv = document.getElementById('messages');
        msgDiv.innerHTML = '';
        snap.forEach(m => {
          const msg = m.data();
          const el = document.createElement('div');
          el.innerText = msg.text;
          el.className = 'message ' + (msg.from === me.uid ? 'you' : 'them');
          msgDiv.appendChild(el);
        });
        msgDiv.scrollTop = msgDiv.scrollHeight;
      });

      chatCol = collection(db, 'chats', chatId, 'msgs');
    }

    async function sendMsg() {
      const text = document.getElementById('msgInput').value.trim();
      if (!text) return;
      await addDoc(chatCol, { from: me.uid, text, createdAt: new Date() });
      document.getElementById('msgInput').value = '';

      // Update chat list metadata
      const otherUid = chatId.split('_').find(u => u !== me.uid);
      await setDoc(doc(db, 'users', me.uid, 'chats', otherUid), { withName: otherUid, lastMsg: new Date() }, { merge:true });
      await setDoc(doc(db, 'users', otherUid, 'chats', me.uid), { withName: me.displayName||me.email, lastMsg: new Date() }, { merge:true });
    }
  </script>
</body>
</html>
